Наша команда занимается бизнес-планированием и коммерческой отчетностью в департаменте разработки продуктов коммерции. Мы поддерживаем и развиваем систему отчетов для руководства и менеджеров, анализируем ключевые метрики и помогаем принимать решения на основе данных.

### 1) Предсказание GMV и поиск аномалий.
Менеджеры каждый день смотрят в BI отчеты. Резкое изменение GMV напрямую влияет на их работу. Им важно понимание, как будет меняться данная метрика в ближайшем будущем. Так же важно быстро выявлять дни, когда показатели существенно отклоняются от нормы (например, сильное падение или рост GMV). Это позволяет оперативно реагировать на ситуацию. Поэтому нужно построить модель, которая предсказывает GMV и определяет, будет ли это отклонение существенным.

**Описание колонок `daily_metrics_dataset.csv`:**

| Название | Описание                                               |
|----------|--------------------------------------------------------|
| `date`   | Дата отчета (формат ГГГГ-ММ-ДД)                        |
| `gmv`   | Фактический GMV за `date`                              |
| `orders`   | Общее количество заказов за `date`                     |
| `sessions`   | Общее количество сессий пользователей за `date`        |
| `marketing_spend`   | Сумма затрат на маркетинг за `date`                    |
| `is_promo_active`   | (0 или 1) Была ли активна крупная промо-акция в `date` |
| `day_of_week`   | День недели (1 - Понедельник, ..., 7 - Воскресенье)    |
| `day_of_year`   | Порядковый номер дня в году                            |
| `week_of_year`   | Порядковый номер недели в году                     |
| `month`   | Месяц                                               |
| `year`    | Год                                                |


**Задача:**
1. Разработать модель(и) машинного обучения для прогнозирования ежедневного GMV (Gross Merchandise Value) и количества заказов на 7 дней вперед. Оценка качества прогнозов на основе MAPE.
  Что нужно сделать:
   * Исследовательский анализ данных (EDA).
   * Подготовка данных и генерация признаков (Feature Engineering).
   * Выбор и обучение модели.
   * Оценка качества прогнозов.
2. На основе полученных прогнозов разработать механизм для определения аномальных дней, когда фактический GMV (или количество заказов) значительно отклоняется от прогнозного значения. 
  Что нужно сделать:
   * Расчет остатков (разницу между фактическими и прогнозными значениями).
   * Определение порога аномалии.  Аномальными будут считаться дни, когда абсолютное значение остатка |факт - прогноз| превышает `threshold = K * std_residuals`.
     * `std_residuals` – это стандартное отклонение остатков (разниц между фактическими и прогнозными значениями), рассчитанное на обучающей или валидационной выборке (после построения модели).
     * `K` – это коэффициент, который определяет чувствительность метода: более высокое значение K означает, что только более крупные отклонения будут считаться аномалиями (менее чувствительная система).
     Более низкое значение K сделает систему более чувствительной к меньшим отклонениям (больше потенциальных аномалий, но и выше риск ложных срабатываний).
     Необходимо поэкспериментировать с различными значениями K и обосновать свой выбор.
   * Детекция аномалий на тестовых данных. Для детекции аномалий используются фактические значения из тестовой выборки (той части исходного набора данных daily_metrics_dataset.csv, которая была отложена для оценки качества моделей прогнозирования в подзадаче 1.1) и прогнозы, полученные моделью для тех же дат. 
   * Визуализация и анализ аномалий (Выбор визуального компеонента остаётся на усмотрение соискателя).

**Критерии готовности для Подзадачи 1.1:**
1. **EDA и Feature Engineering:**
   * Проведен базовый EDA с визуализациями.
   * Сгенерированы релевантные признаки для моделирования временных рядов.
2. **Моделирование:**
   * Данные корректно разделены на train/test/valid.
   * Обучены модели.
   * Реализована и обоснована стратегия прогнозирования на 7 дней вперед.
3. **Оценка:**
   * Рассчитаны и проинтерпретированы метрики качества прогнозов на тестовой выборке.
   * Представлены графики "факт vs прогноз".
4. **Отчет:**
   *  В jupyter notebook описаны все шаги, выбор признаков, моделей, стратегии прогнозирования и результаты.
 
**Критерии готовности для Подзадачи 1.2:**
1. **Расчет порогов:**
   * Корректно рассчитаны остатки модели.
   * Обоснованно выбран и рассчитан порог для детекции аномалий.
2. **Детекция:**
   * Реализован механизм разметки аномальных дней на тестовых данных.
3. **Анализ и Визуализация:**
   * Представлен график с фактическими данными, прогнозами и выделенными аномалиями.
   * Дана краткая оценка работы механизма детекции аномалий.
4. **Связь с Подзадачей 1.1:**
   * Четко показано, как результаты прогнозирования из первой подзадачи используются во второй.

**Критерии оценки:**
* Работоспособность и корректность кода.
* Качество предобработки данных и инжиниринга признаков.
* Обоснованность выбора моделей для прогнозирования.
* Качество прогнозов (MAPE).
* Логичность и реализуемость подхода к детекции аномалий.
* Глубина анализа результатов, понятность и структурированность отчета.

---
### 2) Генерация краткой сводки.
Менеджеры часто не имеют времени глубоко вникать во все цифры отчета. Им нужна краткая текстовая сводка с основными выводами: что выросло, что упало, и насколько это значимо. Поэтому нужно автоматизировать создание таких сводок с помощью LLM

Предоставляются ключевые показатели за период в виде словаря. Данные включают значения метрик и их изменение по сравнению с предыдущим периодом.
```python
# 1. Сильный рост по всем фронтам (День)
daily_strong_growth = {
  "period": "2023-11-15",
  "comparison_period": "2023-11-14",
  "metrics": {
    "GMV": {"value": 1625000, "change": 0.25}, # +25%
    "Заказы": {"value": 2400, "change": 0.20},  # +20%
    "Средний чек (AOV)": {"value": 677.08, "change": 0.042}, # +4.2%
    "Сессии": {"value": 60000, "change": 0.18},  # +18%
    "Конверсия (CR)": {"value": 0.04, "change": 0.017} # +1.7%
  }
}

# 2. Сильное падение по всем фронтам (День)
daily_strong_decline = {
  "period": "2023-11-16",
  "comparison_period": "2023-11-15",
  "metrics": {
    "GMV": {"value": 980000, "change": -0.22},  # -22%
    "Заказы": {"value": 1800, "change": -0.18},  # -18%
    "Средний чек (AOV)": {"value": 544.44, "change": -0.049},# -4.9%
    "Сессии": {"value": 48000, "change": -0.15},  # -15%
    "Конверсия (CR)": {"value": 0.0375, "change": -0.035}# -3.5%
  }
}

# 3. Смешанная динамика: GMV растет, Заказы падают (День) -> Рост за счет AOV
daily_mixed_gmv_up_orders_down = {
  "period": "2023-11-17",
  "comparison_period": "2023-11-16",
  "metrics": {
    "GMV": {"value": 1060000, "change": 0.082}, # +8.2%
    "Заказы": {"value": 1710, "change": -0.05},  # -5%
    "Средний чек (AOV)": {"value": 619.88, "change": 0.139}, # +13.9%
    "Сессии": {"value": 49000, "change": 0.021},  # +2.1%
    "Конверсия (CR)": {"value": 0.0349, "change": -0.069} # -6.9%
  }
}

# 4. Смешанная динамика: GMV падает, Заказы растут (День) -> Падение за счет AOV
daily_mixed_gmv_down_orders_up = {
  "period": "2023-11-18",
  "comparison_period": "2023-11-17",
  "metrics": {
    "GMV": {"value": 985800, "change": -0.07},  # -7%
    "Заказы": {"value": 1778, "change": 0.04},  # +4%
    "Средний чек (AOV)": {"value": 554.44, "change": -0.106},# -10.6%
    "Сессии": {"value": 51000, "change": 0.041},  # +4.1%
    "Конверсия (CR)": {"value": 0.03486, "change": -0.001}# -0.1%
  }
}

# 5. Почти без изменений / Стабильность (День)
daily_flat = {
  "period": "2023-11-19",
  "comparison_period": "2023-11-18",
  "metrics": {
    "GMV": {"value": 990000, "change": 0.004}, # +0.4%
    "Заказы": {"value": 1785, "change": 0.004}, # +0.4%
    "Средний чек (AOV)": {"value": 554.62, "change": 0.0},  # 0%
    "Сессии": {"value": 51100, "change": 0.002}, # +0.2%
    "Конверсия (CR)": {"value": 0.03493, "change": 0.002} # +0.2%
  }
}  

# 6. Умеренный недельный рост
weekly_moderate_growth = {
  "period": "Неделя 46, 2023",
  "comparison_period": "Неделя 45, 2023",
  "metrics": {
    "GMV": {"value": 7800000, "change": 0.09},  # +9%
    "Заказы": {"value": 13500, "change": 0.07},  # +7%
    "Средний чек (AOV)": {"value": 577.78, "change": 0.019}, # +1.9%
    "Сессии": {"value": 450000, "change": 0.05},  # +5%
    "Конверсия (CR)": {"value": 0.03, "change": 0.019} # +1.9%
  }
}

# 7. Недельное падение с аномалией в трафике (GMV/Заказы вниз, Сессии вверх)
weekly_decline_traffic_anomaly = {
  "period": "Неделя 47, 2023",
  "comparison_period": "Неделя 46, 2023",
  "metrics": {
    "GMV": {"value": 7332000, "change": -0.06}, # -6%
    "Заказы": {"value": 12420, "change": -0.08}, # -8%
    "Средний чек (AOV)": {"value": 590.34, "change": 0.022}, # +2.2%
    "Сессии": {"value": 472500, "change": 0.05},  # +5% (аномалия!)
    "Конверсия (CR)": {"value": 0.0263, "change": -0.124} # -12.4%
  }
}

# 8. Фокус на конверсии (День) (GMV/Заказы стабильны, Сессии упали -> CR выросла)
daily_conversion_focus = {
  "period": "2023-11-20",
  "comparison_period": "2023-11-19",
  "metrics": {
    "GMV": {"value": 995000, "change": 0.005}, # +0.5%
    "Заказы": {"value": 1790, "change": 0.003}, # +0.3%
    "Средний чек (AOV)": {"value": 555.87, "change": 0.002}, # +0.2%
    "Сессии": {"value": 48545, "change": -0.05}, # -5%
    "Конверсия (CR)": {"value": 0.03687, "change": 0.056} # +5.6%
  }
}

# 9. Рост за счет AOV (Неделя) (GMV умеренно вырос, Заказы слегка упали)
weekly_aov_driven_growth = {
  "period": "Неделя 48, 2023",
  "comparison_period": "Неделя 47, 2023",
  "metrics": {
    "GMV": {"value": 7845240, "change": 0.07},  # +7%
    "Заказы": {"value": 12234, "change": -0.015}, # -1.5%
    "Средний чек (AOV)": {"value": 641.25, "change": 0.086}, # +8.6%
    "Сессии": {"value": 470000, "change": -0.005}, # -0.5%
    "Конверсия (CR)": {"value": 0.0260, "change": -0.01} # -1%
  }
}

# 10. Резкий всплеск (например, старт большой распродажи) (День)
daily_promo_spike = {
  "period": "2023-11-24", # Черная пятница :)
  "comparison_period": "2023-11-23",
  "metrics": {
    "GMV": {"value": 2400000, "change": 0.6},  # +60%
    "Заказы": {"value": 3100, "change": 0.55},  # +55%
    "Средний чек (AOV)": {"value": 774.19, "change": 0.032}, # +3.2%
    "Сессии": {"value": 80000, "change": 0.4},  # +40%
    "Конверсия (CR)": {"value": 0.03875, "change": 0.107} # +10.7%
  }
}
```

**Задача:**
1) Написать функцию на Python, которая принимает на вход структуру данных с KPI.
2) Используя любую доступную вам LLM (OpenAI API, Hugging Face, Ollama и т.д.), составить промпт (инструкцию) для модели.
3) Промпт должен инструктировать LLM:
   * Действовать как бизнес-аналитик, готовящий краткую сводку для менеджера.
   * На основе предоставленных данных сгенерировать краткий (2-4 предложения) связный текст на русском языке.
   * В тексте нужно упомянуть ключевую метрику (например, GMV), ее динамику (рост/падение в %) и, возможно, кратко указать на динамику связанных метрик (например, заказы, сессии), если они сильно изменились.
   * Использовать только информацию из предоставленных данных.
4) Функция должна вызывать LLM с этим промптом и данными и возвращать сгенерированный текст сводки.
Предоставить краткое описание вашего выбора LLM, ее особенности и возможных улучшений для промпта или подхода.

**Критерии готовности для задачи 2:**
1. **Функциональность:**
   * Написана функция на Python, которая принимает на вход словарь с KPI в указанном формате.
   * Функция успешно вызывает LLM.
   * Функция возвращает строку – сгенерированную текстовую сводку.
2. **Качество Промпта:**
   * Разработан четкий промпт для LLM, который:
     * Задает роль (например, "бизнес-аналитик").
     * Указывает на необходимость использовать только предоставленные данные.
     * Задает формат и стиль ответа (русский язык, 2-4 предложения, деловой тон).
     * Инструктирует фокусироваться на ключевых изменениях.
   * Промпт представлен в коде или отчете.
3. **Качество Сводки:**
   * Сводка релевантна входным данным (отражает указанные изменения GMV и других ключевых метрик).
   * Сводка фактологически верна (не придумывает цифры или тренды).
   * Сводка соответствует заданным ограничениям по длине и стилю.
   * Сводка связная и легко читаемая.
   * Продемонстрирована работа функции на нескольких предоставленных примерах KPI (как минимум 3-4 разных сценария).
4. **Объяснение:**
   * В jupyter notebook кратко описан выбор LLM (если был), основные идеи при составлении промпта.
   * Обсуждаются возможные проблемы и пути улучшения (например, как сделать сводку более точной или как обрабатывать большее разнообразие метрик).

**Ожидаемый результат:**
  * Python скрипт или Jupyter Notebook с кодом функции.
  * Текст финального промпта, который вы использовали.
  * Примеры вызова функции и полученные от нее ответы для выбранных примеров KPI.
  * Краткое текстовое описание подхода.

## Сдача работы и оформление

1. Разместите ваш проект в публичном репозитории на GitHub и отправьте ссылку HR. 
2. Помимо требований, указанных выше, плюсом также будут корректно оформленные коммиты: 
   * Каждый коммит сопровождается кратким описанием внесенных изменений
   * Каждый коммит фокусируется на строго ограниченном участке функционала 


**Полезные материалы:**
* Документация OpenAI API (если используется): [https://platform.openai.com/docs/api-reference](https://platform.openai.com/docs/api-reference)
* Hugging Face Hub (для поиска моделей и использования Inference API): [https://huggingface.co/models](https://huggingface.co/models)
* Библиотека `transformers` (для локального запуска моделей): [https://huggingface.co/docs/transformers/index](https://huggingface.co/docs/transformers/index)
* Статьи по промпт-инжинирингу:
  * [https://www.promptingguide.ai/](https://www.promptingguide.ai/)
  * [https://learnprompting.org/](https://learnprompting.org/)
* LangChain: [https://python.langchain.com/docs/get_started/introduction](https://python.langchain.com/docs/get_started/introduction)
* Pandas, NumPy, Matplotlib, Seaborn для EDA и визуализации.
* Scikit-learn (для моделей регрессии, метрик).
* Библиотеки для градиентного бустинга: XGBoost, LightGBM, CatBoost.
* Статьи и туториалы по прогнозированию временных рядов с помощью ML.
*  Множество примеров на Kaggle.
* Статьи по детекции аномалий во временных рядах.
